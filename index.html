<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMSS 가계부</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #1E3A5F;
            --primary-light: #2E5077;
            --primary-bg: #EEF2F7;
            --accent: #3B82F6;
            --accent-light: #DBEAFE;
            --expense: #DC2626;
            --expense-light: #FEE2E2;
            --income: #059669;
            --income-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
            --radius: 12px;
            --radius-lg: 16px;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 20px 0;
            color: white;
        }

        .header-content { display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 14px; }
        .logo-icon {
            width: 48px; height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
        }
        .logo h1 { font-size: 1.5rem; font-weight: 700; }
        .logo span { font-size: 0.8rem; opacity: 0.8; }
        .header-info { font-size: 0.85rem; opacity: 0.9; }

        /* Navigation */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .tabs { display: flex; gap: 0; }
        .tab {
            padding: 16px 28px;
            background: transparent;
            border: none;
            color: var(--gray-500);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab i { font-size: 1.1rem; }
        .tab:hover { color: var(--gray-700); background: var(--gray-50); }
        .tab.active { color: var(--primary); background: var(--primary-bg); }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: var(--primary);
        }

        main { padding: 28px 0 50px; }

        /* 핵심 지표 카드 */
        .key-metrics {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 28px;
        }

        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .metric-card.main {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .metric-card .label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-card.main .label { color: rgba(255,255,255,0.8); }

        .metric-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-card .sub {
            font-size: 0.85rem;
            color: var(--gray-400);
        }

        .metric-card.main .sub { color: rgba(255,255,255,0.7); }

        .metric-card .change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .metric-card .change.up { background: var(--expense-light); color: var(--expense); }
        .metric-card .change.down { background: var(--income-light); color: var(--income); }
        .metric-card.main .change.up { background: rgba(255,255,255,0.2); color: #FCA5A5; }
        .metric-card.main .change.down { background: rgba(255,255,255,0.2); color: #86EFAC; }

        /* 저축률 카드 */
        .savings-card {
            background: linear-gradient(135deg, var(--income) 0%, #047857 100%);
            color: white;
        }

        .savings-card .label { color: rgba(255,255,255,0.8); }
        .savings-card .sub { color: rgba(255,255,255,0.7); }

        .savings-ring {
            width: 80px;
            height: 80px;
            position: relative;
            margin: 0 auto 12px;
        }

        .savings-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .savings-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .savings-ring .bg { stroke: rgba(255,255,255,0.2); }
        .savings-ring .progress { stroke: white; stroke-linecap: round; transition: stroke-dashoffset 0.5s; }

        .savings-ring .percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* 섹션 */
        .section {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title {
            font-size: 1.05rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .section-body { padding: 24px; }

        /* 예산 현황 */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .budget-item {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--gray-200);
        }

        .budget-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .budget-item-header .category {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .budget-item-header .category .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .budget-item-header .amounts {
            text-align: right;
            font-size: 0.85rem;
        }

        .budget-item-header .amounts .spent {
            font-weight: 600;
            color: var(--gray-700);
        }

        .budget-item-header .amounts .budget {
            color: var(--gray-400);
        }

        .budget-progress {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .budget-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .budget-progress-bar.safe { background: var(--income); }
        .budget-progress-bar.warning { background: var(--warning); }
        .budget-progress-bar.danger { background: var(--expense); }

        .budget-item-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .budget-item-footer .percent {
            font-weight: 600;
        }

        .budget-item-footer .percent.safe { color: var(--income); }
        .budget-item-footer .percent.warning { color: var(--warning); }
        .budget-item-footer .percent.danger { color: var(--expense); }

        .budget-item-footer .remaining {
            color: var(--gray-500);
        }

        /* 고정비/변동비 */
        .expense-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .expense-type-card {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--gray-200);
        }

        .expense-type-card h4 {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .expense-type-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .expense-type-card .percent {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .expense-type-card .items {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--gray-300);
        }

        .expense-type-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.85rem;
        }

        .expense-type-item .name { color: var(--gray-600); }
        .expense-type-item .value { font-weight: 500; color: var(--gray-700); }

        /* 전월 대비 */
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .comparison-column {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--gray-200);
        }

        .comparison-column h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-column.increase h4 { color: var(--expense); }
        .comparison-column.decrease h4 { color: var(--income); }
        .comparison-column.new h4 { color: var(--accent); }

        .comparison-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--gray-200);
        }

        .comparison-item:last-child { margin-bottom: 0; }

        .comparison-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .comparison-item-header .cat { font-weight: 600; font-size: 0.9rem; }
        .comparison-item-header .change { font-weight: 700; font-size: 0.95rem; }
        .comparison-item-header .change.up { color: var(--expense); }
        .comparison-item-header .change.down { color: var(--income); }

        .comparison-item-details {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .comparison-item-list {
            border-top: 1px dashed var(--gray-200);
            padding-top: 8px;
        }

        .comparison-item-list-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 4px 0;
        }

        .comparison-item-list-item .desc {
            color: var(--gray-600);
            max-width: 55%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comparison-item-list-item .amt { color: var(--gray-500); }

        /* 작년 동월 비교 */
        .yoy-comparison {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            align-items: center;
        }

        .yoy-summary {
            text-align: center;
            padding: 20px;
        }

        .yoy-summary .label {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .yoy-summary .value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .yoy-summary .value.up { color: var(--expense); }
        .yoy-summary .value.down { color: var(--income); }

        .yoy-summary .detail {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-top: 8px;
        }

        .yoy-chart { height: 200px; }

        /* 차트 */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-container { height: 280px; position: relative; }

        /* 상세 내역 테이블 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--gray-50);
            padding: 14px 16px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 2px solid var(--gray-200);
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }

        .data-table tbody tr:hover { background: var(--gray-50); }

        .data-table .amount {
            font-weight: 600;
            color: var(--expense);
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            background: var(--gray-100);
        }

        .category-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .fixed-badge {
            background: var(--accent-light);
            color: var(--accent);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        /* 필터 */
        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--gray-700);
            background: white;
            min-width: 150px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-bg);
        }

        .hidden { display: none !important; }

        .no-data {
            text-align: center;
            color: var(--gray-400);
            padding: 30px;
            font-size: 0.9rem;
        }

        /* 반응형 */
        @media (max-width: 1200px) {
            .key-metrics { grid-template-columns: 1fr 1fr; }
            .budget-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .key-metrics { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .comparison-grid { grid-template-columns: 1fr; }
            .expense-split { grid-template-columns: 1fr; }
            .yoy-comparison { grid-template-columns: 1fr; }
            .tab span { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <div class="logo-icon"><i class="ri-wallet-3-fill"></i></div>
                <div>
                    <h1>SMSS 가계부</h1>
                    <span id="headerDate">2026년 1월</span>
                </div>
            </div>
            <div class="header-info">
                <span id="lastUpdated">로딩 중...</span>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">
                    <i class="ri-dashboard-fill"></i>
                    <span>월간 리포트</span>
                </button>
                <button class="tab" onclick="showTab('budget')">
                    <i class="ri-pie-chart-fill"></i>
                    <span>예산 관리</span>
                </button>
                <button class="tab" onclick="showTab('details')">
                    <i class="ri-file-list-3-fill"></i>
                    <span>상세 내역</span>
                </button>
            </div>
        </div>
    </nav>

    <main>
        <div class="container">
            <!-- 월간 리포트 탭 -->
            <div id="overview-tab">
                <!-- 핵심 지표 -->
                <div class="key-metrics">
                    <div class="metric-card main">
                        <div class="label"><i class="ri-calendar-check-fill"></i> 이번 달 지출</div>
                        <div class="value" id="currentMonthExpense">₩0</div>
                        <div class="sub" id="currentMonthCount">0건의 지출</div>
                        <div class="change" id="monthChange">
                            <i class="ri-arrow-up-s-fill"></i>
                            <span>0%</span>
                        </div>
                    </div>
                    <div class="metric-card savings-card">
                        <div class="label"><i class="ri-bank-fill"></i> 저축률</div>
                        <div class="savings-ring">
                            <svg viewBox="0 0 36 36">
                                <circle class="bg" cx="18" cy="18" r="14"/>
                                <circle class="progress" id="savingsProgress" cx="18" cy="18" r="14"
                                    stroke-dasharray="87.96" stroke-dashoffset="87.96"/>
                            </svg>
                            <div class="percentage" id="savingsRate">0%</div>
                        </div>
                        <div class="sub" id="savingsAmount">저축: ₩0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label"><i class="ri-exchange-funds-fill"></i> 작년 동월 대비</div>
                        <div class="value" id="yoyChange">-</div>
                        <div class="sub" id="yoyDetail">비교 데이터 없음</div>
                    </div>
                </div>

                <!-- 고정비/변동비 분리 -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="ri-split-cells-horizontal"></i> 지출 구조 분석</h2>
                    </div>
                    <div class="section-body">
                        <div class="expense-split">
                            <div class="expense-type-card">
                                <h4><i class="ri-lock-fill"></i> 고정비</h4>
                                <div class="amount" id="fixedExpense">₩0</div>
                                <div class="percent" id="fixedPercent">전체의 0%</div>
                                <div class="items" id="fixedItems"></div>
                            </div>
                            <div class="expense-type-card">
                                <h4><i class="ri-shuffle-fill"></i> 변동비</h4>
                                <div class="amount" id="variableExpense">₩0</div>
                                <div class="percent" id="variablePercent">전체의 0%</div>
                                <div class="items" id="variableItems"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 전월 대비 카테고리 분석 -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="ri-bar-chart-grouped-fill"></i> 전월 대비 분석</h2>
                    </div>
                    <div class="section-body">
                        <div class="comparison-grid">
                            <div class="comparison-column increase">
                                <h4><i class="ri-arrow-up-circle-fill"></i> 증가</h4>
                                <div id="increasedCategories"></div>
                            </div>
                            <div class="comparison-column decrease">
                                <h4><i class="ri-arrow-down-circle-fill"></i> 감소</h4>
                                <div id="decreasedCategories"></div>
                            </div>
                            <div class="comparison-column new">
                                <h4><i class="ri-add-circle-fill"></i> 신규</h4>
                                <div id="newCategories"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 작년 동월 비교 -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="ri-calendar-2-fill"></i> 작년 동월 비교</h2>
                    </div>
                    <div class="section-body">
                        <div class="yoy-comparison">
                            <div class="yoy-summary">
                                <div class="label">작년 이맘때 대비</div>
                                <div class="value" id="yoyPercent">-</div>
                                <div class="detail" id="yoyAmounts">비교 데이터 없음</div>
                            </div>
                            <div class="yoy-chart">
                                <canvas id="yoyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 차트 -->
                <div class="charts-grid">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="ri-donut-chart-fill"></i> 카테고리별 지출</h2>
                        </div>
                        <div class="section-body">
                            <div class="chart-container"><canvas id="categoryChart"></canvas></div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title"><i class="ri-line-chart-fill"></i> 월별 추이</h2>
                        </div>
                        <div class="section-body">
                            <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 예산 관리 탭 -->
            <div id="budget-tab" class="hidden">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="ri-funds-box-fill"></i> 카테고리별 예산 현황</h2>
                        <span id="budgetSummary" style="font-size: 0.9rem; color: var(--gray-500);"></span>
                    </div>
                    <div class="section-body">
                        <div class="budget-grid" id="budgetGrid"></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="ri-pie-chart-2-fill"></i> 예산 대비 지출</h2>
                    </div>
                    <div class="section-body">
                        <div class="chart-container"><canvas id="budgetChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- 상세 내역 탭 -->
            <div id="details-tab" class="hidden">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title"><i class="ri-filter-3-fill"></i> 필터</h2>
                        <span id="filteredCount" style="font-size: 0.85rem; color: var(--gray-500);"></span>
                    </div>
                    <div class="section-body">
                        <div class="filter-bar">
                            <div class="filter-group">
                                <label>월</label>
                                <select id="filterMonth"><option value="">전체</option></select>
                            </div>
                            <div class="filter-group">
                                <label>카테고리</label>
                                <select id="filterCategory"><option value="">전체</option></select>
                            </div>
                            <div class="filter-group">
                                <label>지출 유형</label>
                                <select id="filterType">
                                    <option value="">전체</option>
                                    <option value="fixed">고정비</option>
                                    <option value="variable">변동비</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>검색</label>
                                <input type="text" id="filterSearch" placeholder="내용 검색...">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-body" style="padding: 0; overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>카테고리</th>
                                    <th>내용</th>
                                    <th>금액</th>
                                    <th>결제수단</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ===== 설정 =====
        const SHEET_ID = '1EuWNGb3fEpLEbZwocIk6afSmmjiSTo2-rAu5qqfFnbk';
        const GOOGLE_SHEETS = {
            '2025-12': 656326365,
            '2026-01': 989766285
        };
        const MONTHLY_SHEET_GID = 0; // MONTHLY 탭 gid

        // 구글 시트에서 가져온 데이터 (동적으로 채워짐)
        let MONTHLY_INCOME = {};
        let FIXED_EXPENSES = {}; // { '2026-01': { '시리': {...}, '상민': {...}, total: 0 } }

        // 카테고리별 월 예산
        const CATEGORY_BUDGETS = {
            '외식': 400000,
            '식비': 300000,
            '카페': 100000,
            '쇼핑': 200000,
            '생활비': 150000,
            '병원비': 200000,
            '육아비': 500000,
            '약속': 200000,
            '여행비': 300000,
            '차량유지비': 100000,
            '관리비': 200000,
            '경조사비': 100000,
            '교통비': 50000
        };

        // 고정비로 분류할 카테고리 (지출 내역 시트 기준)
        const FIXED_CATEGORIES = ['관리비', '대출이자', '보험료', '통신비', '구독료', '교육비'];

        // 카테고리 색상
        const categoryColors = {
            '외식': '#F97316', '식비': '#22C55E', '카페': '#A16207', '쇼핑': '#A855F7',
            '생활비': '#3B82F6', '병원비': '#EF4444', '육아비': '#EC4899', '약속': '#EAB308',
            '여행비': '#06B6D4', '차량유지비': '#64748B', '관리비': '#14B8A6', '경조사비': '#F43F5E',
            '교통비': '#6366F1', '자기계발비': '#8B5CF6', '건강식품': '#84CC16', '기타': '#9CA3AF'
        };

        let expenseData = { expenses: [], summary: {} };
        let charts = {};

        // ===== 데이터 로드 =====
        async function loadData() {
            try {
                document.getElementById('lastUpdated').textContent = '데이터 로딩 중...';

                // 먼저 MONTHLY 시트에서 수입/고정비 데이터 로드
                await loadMonthlySheet();

                const jsonMonths = ['2025-01', '2025-05', '2025-06', '2025-07', '2025-08', '2025-09', '2025-10', '2025-11'];
                const allExpenses = [];

                for (const month of jsonMonths) {
                    try {
                        const response = await fetch(`data/${month}.json`);
                        const monthData = await response.json();
                        allExpenses.push(...monthData);
                    } catch (e) { console.warn(`Failed to load ${month}.json`); }
                }

                for (const [month, gid] of Object.entries(GOOGLE_SHEETS)) {
                    try {
                        const sheetData = await loadFromGoogleSheets(gid, month);
                        allExpenses.push(...sheetData);
                    } catch (e) {
                        console.warn(`Failed to load Google Sheet for ${month}:`, e);
                        try {
                            const response = await fetch(`data/${month}.json`);
                            const monthData = await response.json();
                            allExpenses.push(...monthData);
                        } catch (e2) { console.warn(`Fallback also failed for ${month}`); }
                    }
                }

                expenseData.expenses = allExpenses;
                calculateSummary();
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('lastUpdated').textContent = '데이터 로딩 실패';
            }
        }

        async function loadFromGoogleSheets(gid, monthKey) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
            const response = await fetch(url);
            const csvText = await response.text();
            return parseCSVToExpenses(csvText, monthKey);
        }

        function parseCSVToExpenses(csvText, monthKey) {
            const lines = csvText.split('\n');
            const expenses = [];
            const [year, month] = monthKey.split('-').map(Number);

            for (let i = 0; i < lines.length; i++) {
                const columns = parseCSVLine(lines[i]);
                const dateStr = columns[0]?.trim();
                if (!dateStr || !dateStr.match(/^\d{4}[\.\-]/)) continue;

                const category = columns[1]?.trim();
                const description = columns[2]?.trim();
                const amountStr = columns[3]?.replace(/[",₩\s]/g, '');
                const amount = parseFloat(amountStr);
                const paymentMethod = columns[5]?.trim();

                if (!category || !amount || isNaN(amount)) continue;

                let normalizedDate = dateStr.replace(/\.\s*/g, '-').replace(/-$/, '');
                if (normalizedDate.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                    const parts = normalizedDate.split('-');
                    normalizedDate = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                }

                expenses.push({
                    date: normalizedDate,
                    year, month, category,
                    description: description || '',
                    amount,
                    payment_method: paymentMethod || '미지정',
                    isFixed: FIXED_CATEGORIES.includes(category),
                    id: `gsheet_${gid}_${i}`
                });
            }
            return expenses;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current); current = ''; }
                else current += char;
            }
            result.push(current);
            return result;
        }

        // MONTHLY 시트에서 수입과 고정비 데이터 로드
        async function loadMonthlySheet() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${MONTHLY_SHEET_GID}`;
                const response = await fetch(url);
                const csvText = await response.text();
                parseMonthlyData(csvText);
            } catch (e) {
                console.warn('Failed to load MONTHLY sheet:', e);
                // 폴백: 기본값 사용
                MONTHLY_INCOME = { '2025-12': 3500000, '2026-01': 3500000 };
            }
        }

        function parseMonthlyData(csvText) {
            const lines = csvText.split('\n');
            // 컬럼 인덱스: 3=1월, 4=2월, ..., 14=12월
            // 2026년 1월은 아직 없으므로 2025년 데이터만 파싱
            const monthColumns = { 1: 3, 2: 4, 3: 5, 4: 6, 5: 7, 6: 8, 7: 9, 8: 10, 9: 11, 10: 12, 11: 13, 12: 14 };

            let currentPerson = '';
            const fixedExpenseItems = { '시리': {}, '상민': {} };
            const monthlyTotals = {};

            for (let i = 0; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                const firstCol = cols[0]?.trim();
                const secondCol = cols[1]?.trim();
                const thirdCol = cols[2]?.trim();

                // 수입 합계 파싱
                if (firstCol === '수입 합계') {
                    for (let m = 1; m <= 12; m++) {
                        const val = parseNumber(cols[monthColumns[m]]);
                        if (val > 0) {
                            MONTHLY_INCOME[`2025-${String(m).padStart(2, '0')}`] = val;
                        }
                    }
                }

                // 고정비 항목 파싱
                if (firstCol === '시리_지출') currentPerson = '시리';
                else if (firstCol === '상민_지출') currentPerson = '상민';
                else if (firstCol === '고정지출 합계') {
                    for (let m = 1; m <= 12; m++) {
                        const val = parseNumber(cols[monthColumns[m]]);
                        if (val > 0) {
                            const monthKey = `2025-${String(m).padStart(2, '0')}`;
                            if (!FIXED_EXPENSES[monthKey]) {
                                FIXED_EXPENSES[monthKey] = { 시리: {}, 상민: {}, total: 0, items: [] };
                            }
                            FIXED_EXPENSES[monthKey].total = val;
                        }
                    }
                    currentPerson = '';
                }

                // 고정비 세부 항목
                if (currentPerson && secondCol === '고정비' && thirdCol) {
                    for (let m = 1; m <= 12; m++) {
                        const val = parseNumber(cols[monthColumns[m]]);
                        if (val > 0) {
                            const monthKey = `2025-${String(m).padStart(2, '0')}`;
                            if (!FIXED_EXPENSES[monthKey]) {
                                FIXED_EXPENSES[monthKey] = { 시리: {}, 상민: {}, total: 0, items: [] };
                            }
                            if (!FIXED_EXPENSES[monthKey][currentPerson]) {
                                FIXED_EXPENSES[monthKey][currentPerson] = {};
                            }
                            FIXED_EXPENSES[monthKey][currentPerson][thirdCol] = val;

                            // items 배열에도 추가
                            const existingItem = FIXED_EXPENSES[monthKey].items.find(
                                item => item.name === thirdCol && item.person === currentPerson
                            );
                            if (!existingItem) {
                                FIXED_EXPENSES[monthKey].items.push({
                                    name: thirdCol,
                                    person: currentPerson,
                                    amount: val
                                });
                            }
                        }
                    }
                }
            }

            // 2026년 1월 데이터는 2025년 12월 기준으로 복사 (또는 최신 데이터 기준)
            if (FIXED_EXPENSES['2025-12']) {
                FIXED_EXPENSES['2026-01'] = JSON.parse(JSON.stringify(FIXED_EXPENSES['2025-12']));
            }
            if (!MONTHLY_INCOME['2026-01'] && MONTHLY_INCOME['2025-12']) {
                MONTHLY_INCOME['2026-01'] = MONTHLY_INCOME['2025-12'];
            }

            console.log('Loaded MONTHLY_INCOME:', MONTHLY_INCOME);
            console.log('Loaded FIXED_EXPENSES:', FIXED_EXPENSES);
        }

        function parseNumber(str) {
            if (!str) return 0;
            const cleaned = str.replace(/[",₩\s()]/g, '').replace(/\(/g, '-');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : Math.abs(num);
        }

        function calculateSummary() {
            const expenses = expenseData.expenses;
            const categoryBreakdown = {};
            const monthlyTotals = {};

            expenses.forEach(exp => {
                exp.isFixed = FIXED_CATEGORIES.includes(exp.category);
                const monthKey = `${exp.year}-${String(exp.month).padStart(2, '0')}`;

                categoryBreakdown[exp.category] = (categoryBreakdown[exp.category] || 0) + exp.amount;

                if (!monthlyTotals[monthKey]) {
                    monthlyTotals[monthKey] = { total: 0, categories: {}, fixed: 0, variable: 0 };
                }
                monthlyTotals[monthKey].total += exp.amount;
                monthlyTotals[monthKey].categories[exp.category] = (monthlyTotals[monthKey].categories[exp.category] || 0) + exp.amount;
                if (exp.isFixed) monthlyTotals[monthKey].fixed += exp.amount;
                else monthlyTotals[monthKey].variable += exp.amount;
            });

            expenseData.summary = {
                total_expenses: expenses.reduce((sum, e) => sum + e.amount, 0),
                total_transactions: expenses.length,
                category_breakdown: categoryBreakdown,
                monthly_totals: monthlyTotals
            };
        }

        // ===== 대시보드 초기화 =====
        function initializeDashboard() {
            const now = new Date();
            document.getElementById('headerDate').textContent = `${now.getFullYear()}년 ${now.getMonth() + 1}월`;
            document.getElementById('lastUpdated').textContent = `${expenseData.expenses.length}건 로드됨`;

            updateKeyMetrics();
            updateExpenseSplit();
            updateCategoryComparison();
            updateYoYComparison();
            destroyCharts();
            createCharts();
            updateBudgetTab();
            populateFilters();
            renderExpenseTable();
        }

        function destroyCharts() {
            Object.values(charts).forEach(c => c?.destroy());
            charts = {};
        }

        // ===== 핵심 지표 =====
        function updateKeyMetrics() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const lastKey = `${now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear()}-${String(now.getMonth() === 0 ? 12 : now.getMonth()).padStart(2, '0')}`;

            const currentVariable = expenseData.summary.monthly_totals[currentKey] || { total: 0 };
            const lastVariable = expenseData.summary.monthly_totals[lastKey] || { total: 0 };

            // 고정비 포함 총 지출 계산
            const currentFixed = FIXED_EXPENSES[currentKey]?.total || 0;
            const lastFixed = FIXED_EXPENSES[lastKey]?.total || 0;

            const currentTotal = currentVariable.total + currentFixed;
            const lastTotal = lastVariable.total + lastFixed;

            const currentExpenses = expenseData.expenses.filter(e => `${e.year}-${String(e.month).padStart(2, '0')}` === currentKey);

            document.getElementById('currentMonthExpense').textContent = formatCurrency(currentTotal);
            document.getElementById('currentMonthCount').textContent = `변동비 ${currentExpenses.length}건 + 고정비`;

            const changeEl = document.getElementById('monthChange');
            if (lastTotal > 0) {
                const diff = currentTotal - lastTotal;
                const percent = ((diff / lastTotal) * 100).toFixed(1);
                const isUp = diff > 0;
                changeEl.className = `change ${isUp ? 'up' : 'down'}`;
                changeEl.innerHTML = `<i class="ri-arrow-${isUp ? 'up' : 'down'}-s-fill"></i><span>${isUp ? '+' : ''}${percent}% 전월대비</span>`;
            } else {
                changeEl.innerHTML = '<span>전월 데이터 없음</span>';
            }

            // 저축률 (수입은 구글 시트에서 가져온 값 사용)
            const income = MONTHLY_INCOME[currentKey] || 3500000;
            const savings = income - currentTotal;
            const savingsRate = income > 0 ? Math.max(0, (savings / income) * 100) : 0;

            document.getElementById('savingsRate').textContent = `${savingsRate.toFixed(0)}%`;
            document.getElementById('savingsAmount').textContent = savings >= 0
                ? `저축: ${formatCurrency(savings)}`
                : `적자: ${formatCurrency(Math.abs(savings))}`;

            const circumference = 87.96;
            const offset = circumference - (Math.min(savingsRate, 100) / 100) * circumference;
            document.getElementById('savingsProgress').style.strokeDashoffset = offset;
        }

        // ===== 고정비/변동비 =====
        function updateExpenseSplit() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const currentData = expenseData.summary.monthly_totals[currentKey] || { total: 0, fixed: 0, variable: 0 };
            const currentExpenses = expenseData.expenses.filter(e => `${e.year}-${String(e.month).padStart(2, '0')}` === currentKey);

            // 구글 시트에서 가져온 고정비 데이터 사용
            const sheetFixed = FIXED_EXPENSES[currentKey];
            const fixedFromSheet = sheetFixed?.total || 0;

            // 변동비 = 이번 달 총 지출 (지출 내역 시트) - 실제 고정비는 별도 계산
            const totalFromExpenses = currentData.total || 0;
            const variable = totalFromExpenses; // 지출 내역은 모두 변동비로 간주

            // 전체 지출 = 고정비(MONTHLY 시트) + 변동비(지출 내역 시트)
            const totalAll = fixedFromSheet + variable;

            document.getElementById('fixedExpense').textContent = formatCurrency(fixedFromSheet);
            document.getElementById('fixedPercent').textContent = totalAll > 0
                ? `전체의 ${((fixedFromSheet / totalAll) * 100).toFixed(1)}%`
                : '전체의 0%';

            document.getElementById('variableExpense').textContent = formatCurrency(variable);
            document.getElementById('variablePercent').textContent = totalAll > 0
                ? `전체의 ${((variable / totalAll) * 100).toFixed(1)}%`
                : '전체의 0%';

            // 고정비 항목 (구글 시트 MONTHLY 탭에서)
            if (sheetFixed && sheetFixed.items && sheetFixed.items.length > 0) {
                const sortedItems = [...sheetFixed.items].sort((a, b) => b.amount - a.amount);
                document.getElementById('fixedItems').innerHTML = sortedItems.slice(0, 7)
                    .map(item => `
                        <div class="expense-type-item">
                            <span class="name">${item.name} <small style="color: var(--gray-400);">(${item.person})</small></span>
                            <span class="value">${formatCurrency(item.amount)}</span>
                        </div>
                    `).join('');
            } else {
                document.getElementById('fixedItems').innerHTML = '<div class="no-data">고정비 데이터 없음</div>';
            }

            // 변동비 항목 (지출 내역 시트에서 카테고리별)
            const variableByCategory = {};
            currentExpenses.forEach(e => {
                variableByCategory[e.category] = (variableByCategory[e.category] || 0) + e.amount;
            });

            document.getElementById('variableItems').innerHTML = Object.entries(variableByCategory)
                .sort((a, b) => b[1] - a[1]).slice(0, 5)
                .map(([cat, amt]) => `<div class="expense-type-item"><span class="name">${cat}</span><span class="value">${formatCurrency(amt)}</span></div>`)
                .join('') || '<div class="no-data">변동비 없음</div>';
        }

        // ===== 전월 대비 카테고리 분석 =====
        function updateCategoryComparison() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const lastKey = `${now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear()}-${String(now.getMonth() === 0 ? 12 : now.getMonth()).padStart(2, '0')}`;

            const currentCats = expenseData.summary.monthly_totals[currentKey]?.categories || {};
            const lastCats = expenseData.summary.monthly_totals[lastKey]?.categories || {};

            const currentExpenses = expenseData.expenses.filter(e => `${e.year}-${String(e.month).padStart(2, '0')}` === currentKey);
            const byCategory = {};
            currentExpenses.forEach(e => {
                if (!byCategory[e.category]) byCategory[e.category] = [];
                byCategory[e.category].push(e);
            });

            const increased = [], decreased = [], newCats = [];
            const allCats = new Set([...Object.keys(currentCats), ...Object.keys(lastCats)]);

            allCats.forEach(cat => {
                const curr = currentCats[cat] || 0;
                const last = lastCats[cat] || 0;
                const diff = curr - last;
                const items = byCategory[cat] || [];

                if (last === 0 && curr > 0) {
                    newCats.push({ cat, curr, items });
                } else if (diff > 0) {
                    increased.push({ cat, curr, last, diff, percent: ((diff / last) * 100).toFixed(0), items });
                } else if (diff < 0) {
                    decreased.push({ cat, curr, last, diff: Math.abs(diff), percent: ((Math.abs(diff) / last) * 100).toFixed(0), items });
                }
            });

            increased.sort((a, b) => b.diff - a.diff);
            decreased.sort((a, b) => b.diff - a.diff);

            const renderItems = (items) => items.sort((a, b) => b.amount - a.amount).slice(0, 2)
                .map(i => `<div class="comparison-item-list-item"><span class="desc">${i.description || '-'}</span><span class="amt">${formatCurrency(i.amount)}</span></div>`).join('');

            document.getElementById('increasedCategories').innerHTML = increased.length > 0 ?
                increased.slice(0, 4).map(i => `
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <span class="cat">${i.cat}</span>
                            <span class="change up">+${formatCurrency(i.diff)}</span>
                        </div>
                        <div class="comparison-item-details">${formatCurrency(i.last)} → ${formatCurrency(i.curr)} (+${i.percent}%)</div>
                        <div class="comparison-item-list">${renderItems(i.items)}</div>
                    </div>
                `).join('') : '<div class="no-data">증가 항목 없음</div>';

            document.getElementById('decreasedCategories').innerHTML = decreased.length > 0 ?
                decreased.slice(0, 4).map(i => `
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <span class="cat">${i.cat}</span>
                            <span class="change down">-${formatCurrency(i.diff)}</span>
                        </div>
                        <div class="comparison-item-details">${formatCurrency(i.last)} → ${formatCurrency(i.curr)} (-${i.percent}%)</div>
                        <div class="comparison-item-list">${renderItems(i.items)}</div>
                    </div>
                `).join('') : '<div class="no-data">감소 항목 없음</div>';

            document.getElementById('newCategories').innerHTML = newCats.length > 0 ?
                newCats.slice(0, 4).map(i => `
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <span class="cat">${i.cat}</span>
                            <span class="change up">${formatCurrency(i.curr)}</span>
                        </div>
                        <div class="comparison-item-details">신규 지출</div>
                        <div class="comparison-item-list">${renderItems(i.items)}</div>
                    </div>
                `).join('') : '<div class="no-data">신규 항목 없음</div>';
        }

        // ===== 작년 동월 비교 =====
        function updateYoYComparison() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const lastYearKey = `${now.getFullYear() - 1}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const current = expenseData.summary.monthly_totals[currentKey]?.total || 0;
            const lastYear = expenseData.summary.monthly_totals[lastYearKey]?.total || 0;

            const yoyEl = document.getElementById('yoyChange');
            const yoyPercentEl = document.getElementById('yoyPercent');
            const yoyDetailEl = document.getElementById('yoyDetail');
            const yoyAmountsEl = document.getElementById('yoyAmounts');

            if (lastYear > 0) {
                const diff = current - lastYear;
                const percent = ((diff / lastYear) * 100).toFixed(1);
                const isUp = diff > 0;

                yoyEl.innerHTML = `<span style="color: ${isUp ? 'var(--expense)' : 'var(--income)'};">${isUp ? '+' : ''}${percent}%</span>`;
                yoyEl.className = `value ${isUp ? 'up' : 'down'}`;
                yoyDetailEl.textContent = `${isUp ? '증가' : '감소'} ${formatCurrency(Math.abs(diff))}`;

                yoyPercentEl.textContent = `${isUp ? '+' : ''}${percent}%`;
                yoyPercentEl.className = `value ${isUp ? 'up' : 'down'}`;
                yoyAmountsEl.textContent = `${now.getFullYear() - 1}년: ${formatCurrency(lastYear)} → ${now.getFullYear()}년: ${formatCurrency(current)}`;
            } else {
                yoyEl.textContent = '-';
                yoyDetailEl.textContent = '작년 데이터 없음';
                yoyPercentEl.textContent = '-';
                yoyAmountsEl.textContent = '비교할 데이터가 없습니다';
            }
        }

        // ===== 예산 탭 =====
        function updateBudgetTab() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const currentCats = expenseData.summary.monthly_totals[currentKey]?.categories || {};

            let overBudgetCount = 0;
            let html = '';

            Object.entries(CATEGORY_BUDGETS).sort((a, b) => {
                const spentA = currentCats[a[0]] || 0;
                const spentB = currentCats[b[0]] || 0;
                return (spentB / b[1]) - (spentA / a[1]);
            }).forEach(([cat, budget]) => {
                const spent = currentCats[cat] || 0;
                const percent = Math.min((spent / budget) * 100, 150);
                const remaining = budget - spent;
                const status = percent >= 100 ? 'danger' : percent >= 80 ? 'warning' : 'safe';
                if (percent >= 100) overBudgetCount++;
                const color = categoryColors[cat] || '#9CA3AF';

                html += `
                    <div class="budget-item">
                        <div class="budget-item-header">
                            <div class="category">
                                <span class="dot" style="background: ${color};"></span>
                                ${cat}
                            </div>
                            <div class="amounts">
                                <span class="spent">${formatCurrency(spent)}</span>
                                <span class="budget"> / ${formatCurrency(budget)}</span>
                            </div>
                        </div>
                        <div class="budget-progress">
                            <div class="budget-progress-bar ${status}" style="width: ${Math.min(percent, 100)}%;"></div>
                        </div>
                        <div class="budget-item-footer">
                            <span class="percent ${status}">${percent.toFixed(0)}%</span>
                            <span class="remaining">${remaining >= 0 ? `남은 금액: ${formatCurrency(remaining)}` : `초과: ${formatCurrency(Math.abs(remaining))}`}</span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('budgetGrid').innerHTML = html;
            document.getElementById('budgetSummary').textContent = overBudgetCount > 0 ?
                `⚠️ ${overBudgetCount}개 카테고리 예산 초과` : '✅ 모든 카테고리 예산 내 지출';
        }

        // ===== 차트 =====
        function createCharts() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const currentCats = expenseData.summary.monthly_totals[currentKey]?.categories || {};

            // 카테고리 도넛 차트
            const sortedCats = Object.entries(currentCats).sort((a, b) => b[1] - a[1]).slice(0, 8);
            if (sortedCats.length > 0) {
                charts.category = new Chart(document.getElementById('categoryChart'), {
                    type: 'doughnut',
                    data: {
                        labels: sortedCats.map(([k]) => k),
                        datasets: [{
                            data: sortedCats.map(([, v]) => v),
                            backgroundColor: sortedCats.map(([k]) => categoryColors[k] || '#9CA3AF'),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '65%',
                        plugins: {
                            legend: { position: 'right', labels: { padding: 12, usePointStyle: true } },
                            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}` } }
                        }
                    }
                });
            }

            // 월별 추이 차트
            const monthlyData = expenseData.summary.monthly_totals;
            const sortedMonths = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0])).slice(-6);
            if (sortedMonths.length > 0) {
                charts.monthly = new Chart(document.getElementById('monthlyChart'), {
                    type: 'bar',
                    data: {
                        labels: sortedMonths.map(([k]) => k.substring(2)),
                        datasets: [{
                            label: '지출',
                            data: sortedMonths.map(([, v]) => v.total),
                            backgroundColor: 'rgba(30, 58, 95, 0.8)',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: v => (v / 10000) + '만' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // YoY 차트
            const currentMonth = now.getMonth() + 1;
            const yoyData = [];
            [now.getFullYear() - 1, now.getFullYear()].forEach(year => {
                const key = `${year}-${String(currentMonth).padStart(2, '0')}`;
                yoyData.push({ year, total: monthlyData[key]?.total || 0 });
            });

            charts.yoy = new Chart(document.getElementById('yoyChart'), {
                type: 'bar',
                data: {
                    labels: yoyData.map(d => `${d.year}년`),
                    datasets: [{
                        label: `${currentMonth}월 지출`,
                        data: yoyData.map(d => d.total),
                        backgroundColor: ['rgba(156, 163, 175, 0.6)', 'rgba(30, 58, 95, 0.8)'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, ticks: { callback: v => (v / 10000) + '만' } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // 예산 차트
            const budgetData = Object.entries(CATEGORY_BUDGETS).map(([cat, budget]) => ({
                cat, budget, spent: currentCats[cat] || 0
            })).sort((a, b) => (b.spent / b.budget) - (a.spent / a.budget)).slice(0, 6);

            charts.budget = new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: {
                    labels: budgetData.map(d => d.cat),
                    datasets: [
                        { label: '지출', data: budgetData.map(d => d.spent), backgroundColor: 'rgba(220, 38, 38, 0.7)', borderRadius: 4 },
                        { label: '예산', data: budgetData.map(d => d.budget), backgroundColor: 'rgba(209, 213, 219, 0.5)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => (v / 10000) + '만' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // ===== 필터 및 테이블 =====
        function populateFilters() {
            const months = [...new Set(Object.keys(expenseData.summary.monthly_totals))].sort().reverse();
            const categories = Object.keys(expenseData.summary.category_breakdown).sort();

            const monthSelect = document.getElementById('filterMonth');
            monthSelect.innerHTML = '<option value="">전체</option>' + months.map(m => `<option value="${m}">${m}</option>`).join('');

            const categorySelect = document.getElementById('filterCategory');
            categorySelect.innerHTML = '<option value="">전체</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');

            document.getElementById('filterMonth').onchange = renderExpenseTable;
            document.getElementById('filterCategory').onchange = renderExpenseTable;
            document.getElementById('filterType').onchange = renderExpenseTable;
            document.getElementById('filterSearch').oninput = renderExpenseTable;
        }

        function renderExpenseTable() {
            const month = document.getElementById('filterMonth').value;
            const category = document.getElementById('filterCategory').value;
            const type = document.getElementById('filterType').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            let filtered = [...expenseData.expenses];

            if (month) filtered = filtered.filter(e => `${e.year}-${String(e.month).padStart(2, '0')}` === month);
            if (category) filtered = filtered.filter(e => e.category === category);
            if (type === 'fixed') filtered = filtered.filter(e => e.isFixed);
            if (type === 'variable') filtered = filtered.filter(e => !e.isFixed);
            if (search) filtered = filtered.filter(e => (e.description || '').toLowerCase().includes(search));

            filtered.sort((a, b) => b.date.localeCompare(a.date));

            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = filtered.slice(0, 100).map(e => {
                const color = categoryColors[e.category] || '#9CA3AF';
                return `
                    <tr>
                        <td>${e.date}</td>
                        <td>
                            <span class="category-badge">
                                <span class="dot" style="background: ${color};"></span>
                                ${e.category}
                            </span>
                            ${e.isFixed ? '<span class="fixed-badge">고정</span>' : ''}
                        </td>
                        <td>${e.description || '-'}</td>
                        <td class="amount">${formatCurrency(e.amount)}</td>
                        <td>${e.payment_method}</td>
                    </tr>
                `;
            }).join('');

            const total = filtered.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('filteredCount').textContent = `${filtered.length}건 · ${formatCurrency(total)}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('[id$="-tab"]').forEach(t => t.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }

        loadData();
    </script>
</body>
</html>
